name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DOCKERHUB_IMAGE: palemoky/eink-panel
  GHCR_IMAGE: ghcr.io/palemoky/eink-panel

jobs:
  # Run tests before building and publishing
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-suffix: v1

      - name: Install dependencies
        run: |
          uv sync --frozen --extra dev

      - name: Run tests
        run: |
          uv run pytest tests/

  # Build and publish Docker images to Docker Hub and GHCR
  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up QEMU for multi-architecture builds (ARM64 for Raspberry Pi)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Login to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate Docker metadata (tags and labels)
      - name: Extract metadata for Docker Hub
        id: meta-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Extract metadata for GHCR
        id: meta-ghcr
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GHCR_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      # Build and push to both Docker Hub and GHCR in one step
      - name: Build and push to Docker Hub and GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta-dockerhub.outputs.tags }}
            ${{ steps.meta-ghcr.outputs.tags }}
          labels: ${{ steps.meta-dockerhub.outputs.labels }}
          # Multi-platform build: AMD64 (PC) and ARM64 (Raspberry Pi 3/4/5 64-bit)
          platforms: linux/amd64,linux/arm64
          # Docker cache disabled - UV cache already speeds up dependency installation
          # Avoids wasteful buildkit-blob-* cache files with low hit rate
          provenance: false
          sbom: false

      # Clean up old alpha/beta/rc images (keep only the latest 2 versions)
      - name: Clean up old pre-release images
        if: contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc')
        run: |
          echo "Cleaning up old pre-release images..."
          
          # Clean up GHCR old images (keep latest 2 alpha versions)
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /user/packages/container/${{ github.event.repository.name }}/versions \
            --jq '.[] | select(.metadata.container.tags[] | contains("alpha") or contains("beta") or contains("rc")) | .id' \
            | tail -n +3 \
            | xargs -I {} gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /user/packages/container/${{ github.event.repository.name }}/versions/{} \
            || echo "No old pre-release images to clean"
          
          # Clean up Docker Hub old images (keep latest 2 alpha versions)
          echo "Cleaning up Docker Hub pre-release images..."
          
          # Get Docker Hub token
          HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          # Get all tags
          REPO_NAME="${{ env.DOCKERHUB_IMAGE }}"
          TAGS=$(curl -s -H "Authorization: JWT ${HUB_TOKEN}" \
            "https://hub.docker.com/v2/repositories/${REPO_NAME}/tags/?page_size=100" \
            | jq -r '.results[] | select(.name | test("alpha|beta|rc")) | .name' \
            | sort -V)
          
          # Keep latest 2, delete others
          OLD_TAGS=$(echo "$TAGS" | head -n -2)
          
          if [ -n "$OLD_TAGS" ]; then
            echo "Deleting old tags: $OLD_TAGS"
            echo "$OLD_TAGS" | while read tag; do
              curl -X DELETE \
                -H "Authorization: JWT ${HUB_TOKEN}" \
                "https://hub.docker.com/v2/repositories/${REPO_NAME}/tags/${tag}/" \
                && echo "Deleted tag: $tag" \
                || echo "Failed to delete tag: $tag"
            done
          else
            echo "No old Docker Hub tags to clean"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Notify on failure via Xiaomi Speaker
      - name: Notify via Xiaomi Speaker
        if: failure()
        env:
          MI_USER: ${{ secrets.MI_USER }}
          MI_PASS: ${{ secrets.MI_PASS }}
          MI_BOX_DID: ${{ secrets.MI_BOX_DID }}
          NOTIFY_MSG: "Alert: Release failed for ${{ github.repository }}"
        run: |
          uv pip install --system aiohttp aiofiles miservice
          python .github/scripts/notify_xiaomi_speaker.py

  # Sync README to Docker Hub (after successful image build)
  sync-readme:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_IMAGE }}
          readme-filepath: ./README.md
