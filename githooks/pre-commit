#!/bin/sh
# Pre-commit hook for Python code formatting and linting

# è·å– Git ä»“åº“çš„æ ¹ç›®å½•
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

printf "ğŸ” Checking staged Python files...\n"

# æŸ¥æ‰¾å·²æš‚å­˜çš„ Python æ–‡ä»¶
staged_py_files=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.py$")

# å¦‚æœæ²¡æœ‰ Python æ–‡ä»¶è¢«æš‚å­˜ï¼Œç›´æ¥é€€å‡º
if [ -z "$staged_py_files" ]; then
    printf "âœ… No Python files to check\n"
    exit 0
fi

printf "ğŸ“ Found Python files to format:\n"
printf "%s\n" "$staged_py_files"

# è¿è¡Œ ruff formatï¼ˆæ›¿ä»£ blackï¼‰
printf "\n"
printf "ğŸ¨ Running ruff format...\n"
if ! uv run ruff format --check $staged_py_files 2>&1; then
    printf "âš ï¸  Code needs formatting. Auto-formatting...\n"
    uv run ruff format $staged_py_files
    # é‡æ–°æš‚å­˜æ ¼å¼åŒ–åçš„æ–‡ä»¶
    echo "$staged_py_files" | xargs git add
    printf "âœ… Files formatted with ruff\n"
fi

# è¿è¡Œ ruff æ£€æŸ¥ä»£ç è´¨é‡ï¼ˆåŒ…æ‹¬å¯¼å…¥æ’åºï¼‰
printf "\n"
printf "ğŸ” Running ruff check...\n"
if ! uv run ruff check --fix $staged_py_files; then
    printf "âŒ Ruff found issues that couldn't be auto-fixed.\n"
    printf "ğŸ’¡ Please review and fix the issues manually.\n"
    exit 1
fi

# å¦‚æœ ruff --fix ä¿®æ”¹äº†æ–‡ä»¶ï¼Œé‡æ–°æš‚å­˜
echo "$staged_py_files" | xargs git add

printf "\n"
printf "âœ… All checks passed! Ready to commit.\n"
exit 0