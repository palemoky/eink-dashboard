#!/bin/sh
# Pre-commit hook for Python code formatting and linting

# è·å– Git ä»“åº“çš„æ ¹ç›®å½•
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

echo "ğŸ” Checking staged Python files..."

# æŸ¥æ‰¾å·²æš‚å­˜çš„ Python æ–‡ä»¶
staged_py_files=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.py$")

# å¦‚æœæ²¡æœ‰ Python æ–‡ä»¶è¢«æš‚å­˜ï¼Œç›´æ¥é€€å‡º
if [ -z "$staged_py_files" ]; then
    echo "âœ… No Python files to check"
    exit 0
fi

echo "ğŸ“ Found Python files to format:"
echo "$staged_py_files"

# è¿è¡Œ black æ ¼å¼åŒ–
echo ""
echo "ğŸ¨ Running black..."
if ! black --check $staged_py_files 2>&1; then
    echo "âš ï¸  Code needs formatting. Auto-formatting..."
    black $staged_py_files
    # é‡æ–°æš‚å­˜æ ¼å¼åŒ–åçš„æ–‡ä»¶
    echo "$staged_py_files" | xargs git add
    echo "âœ… Files formatted with black"
fi

# è¿è¡Œ isort æ•´ç†å¯¼å…¥
echo ""
echo "ğŸ“¦ Running isort..."
if ! isort --check $staged_py_files 2>&1; then
    echo "âš ï¸  Imports need sorting. Auto-sorting..."
    isort $staged_py_files
    # é‡æ–°æš‚å­˜æ’åºåçš„æ–‡ä»¶
    echo "$staged_py_files" | xargs git add
    echo "âœ… Imports sorted with isort"
fi

# è¿è¡Œ ruff æ£€æŸ¥ä»£ç è´¨é‡
echo ""
echo "ğŸ” Running ruff..."
if ! ruff check $staged_py_files; then
    echo "âŒ Ruff found issues. Please fix them before committing."
    echo "ğŸ’¡ Tip: Run 'ruff check --fix' to auto-fix some issues"
    exit 1
fi

echo ""
echo "âœ… All checks passed! Ready to commit."
exit 0